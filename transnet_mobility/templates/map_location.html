{% extends 'base.html' %}

{% block title %}Train Tracker - South Africa{% endblock %}

{% block content %}

<div id="map" style="height: 600px;"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map("map").setView([-26.11938, 27.7490656], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);

    var userMarkers = {};

    function loadLocations() {
        fetch("/api/update-location/")
            .then(res => res.json())
            .then(data => {
                data.forEach(item => {
                    let userId = item.user.id;
                    let popupContent = `
                        <b>${item.user.email}</b><br>
                        Role: ${item.user.role}<br>
                        Phone: ${item.user.phone || "N/A"}<br>
                        Last seen: ${item.timestamp}
                    `;

                    if (userMarkers[userId]) {
                        userMarkers[userId].setLatLng([item.lat, item.lng]);
                        userMarkers[userId].setPopupContent(popupContent);
                    } else {
                        userMarkers[userId] = L.marker([item.lat, item.lng])
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });
            });
    }

    function sendLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                fetch("/api/update-location/", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    })
                });
            });
        }
    }

    // Load map and markers
    loadLocations();
    setInterval(loadLocations, 10000);  // refresh markers every 10s
    setInterval(sendLocation, 5000);    // send user location every 5s
</script>

{% endblock %}
